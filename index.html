<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Voice Recording Interface</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#000000" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Voice Recorder" />
    <meta name="format-detection" content="telephone=no" />
  </head>
  <body>
    <div class="container">
      <div class="single-question-container">
        <div class="question-and-skip-container">
          <div class="question-display">
            <h2 id="current-question">Loading question...</h2>
          </div>
          <button class="skip-btn" id="skip-question-btn" title="Skip Question">
            <span class="skip-text">Skip Question</span>
            <span class="skip-arrow">â†’</span>
          </button>
        </div>

        <button class="record-btn" id="main-record-btn">
          <span class="btn-text">Tap to Record Your Response</span>
          <span class="recording-indicator"></span>
        </button>
      </div>
    </div>

    <!-- Recording Confirmation Modal -->
    <div id="recording-confirmation-modal" class="modal">
      <div class="modal-content">
        <h3>Voice Recording Consent</h3>
        <p>
          Are you sure you want to record your voice response? Your recording
          will be stored securely for research purposes.
        </p>
        <div class="modal-buttons">
          <button id="confirm-recording" class="consent-btn">
            Yes, Record
          </button>
          <button id="cancel-recording" class="consent-btn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- GDPR Consent Modal -->
    <div id="gdpr-modal" class="modal">
      <div class="modal-content">
        <h3>Data Collection Consent</h3>
        <p>
          Your voice recording will be stored securely on Microsoft OneDrive for
          research purposes. You can request deletion at any time by contacting
          us.
        </p>
        <div class="modal-buttons">
          <button id="consent-yes" class="consent-btn">I Consent</button>
          <button id="consent-no" class="consent-btn">Decline</button>
        </div>
      </div>
    </div>

    <!-- Recording Status -->
    <div id="status-display" class="status-hidden">
      <div class="status-content">
        <div class="pulse-animation"></div>
        <p id="status-text">Ready to record...</p>
      </div>
    </div>

    <!-- Version Display -->
    <div id="version-display">
      <span id="version-text">v2.3.0</span>
    </div>

    <!-- Microsoft Graph SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
      // --- GitHub Commit Info Display ---
      document.addEventListener("DOMContentLoaded", function () {
        // TODO: Update these with your actual GitHub details when you create the repo
        const username = "uselessnesses"; // CHANGE to your GitHub username
        const repo = "authenticity-unmasked"; // CHANGE to your repo name
        const branch = "main";
        const versionDisplay = document.getElementById("version-display");
        const versionText = document.getElementById("version-text");

        if (!versionDisplay || !versionText) return;

        // Ensure AZURE_CONFIG is available
        const version = window.AZURE_CONFIG?.VERSION || "2.3.0";
        const buildDate = window.AZURE_CONFIG?.BUILD_DATE || "";
        const buildTime = window.AZURE_CONFIG?.BUILD_TIME || "";

        // Try to fetch GitHub workflow runs for auto-versioning
        // This counts actual deployments/builds rather than just commits
        Promise.all([
          fetch(
            `https://api.github.com/repos/${username}/${repo}/commits?sha=${branch}&per_page=1`
          ),
          fetch(
            `https://api.github.com/repos/${username}/${repo}/actions/runs?status=completed&per_page=100`
          ),
        ])
          .then(async ([latestResponse, workflowResponse]) => {
            let autoVersion = `v${version}`; // fallback to config version

            // Try to get workflow run count for auto-versioning
            if (workflowResponse.ok) {
              const workflowData = await workflowResponse.json();
              const completedRuns =
                workflowData.total_count ||
                workflowData.workflow_runs?.length ||
                0;
              autoVersion = `v1.${completedRuns}`;
            }

            // Get latest commit info
            if (latestResponse.ok) {
              const [latestCommit] = await latestResponse.json();

              if (
                latestCommit &&
                latestCommit.sha &&
                latestCommit.commit &&
                latestCommit.commit.message &&
                latestCommit.commit.author &&
                latestCommit.commit.author.date
              ) {
                // Parse the commit date
                const commitDate = new Date(latestCommit.commit.author.date);
                const publishDate = commitDate
                  .toLocaleDateString("en-GB", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                  })
                  .replace(/\//g, "-"); // Format: DD-MM-YYYY

                const publishTime = commitDate.toLocaleTimeString("en-GB", {
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: false,
                }); // Format: HH:MM

                const msg = latestCommit.commit.message.split("\n")[0];

                // Set the format: "auto version, date of publish, time of publish, commit message"
                versionText.textContent = `${autoVersion}, ${publishDate}, ${publishTime}, ${msg}`;
                return;
              }
            }

            // Fallback if commit info unavailable
            versionText.textContent = `${autoVersion}, ${buildDate || "N/A"}, ${
              buildTime || "N/A"
            }, Built locally`;
          })
          .catch((error) => {
            console.log("GitHub API unavailable:", error.message);
            // Fallback to config data with same format, using manual version
            versionText.textContent = `v${version}, ${buildDate || "N/A"}, ${
              buildTime || "N/A"
            }, Built locally`;
          });
      });
    </script>
  </body>
</html>
